import axios from "axios";
import { HttpStatusCode } from "../../enums";
import { IPayloadPostResponse } from "../../interfaces";

interface IAbstractPayloadService {
    postBINLoaderPayload: (payload: ArrayBuffer) => Promise<IPayloadPostResponse>
}

abstract class AbstractPayloadService implements IAbstractPayloadService {
    private binLoaderEndpoint: string
    private binLoaderStatusEndpoint: string

    constructor(binLoaderEndpoint: string, binLoaderStatusEndpoint: string) {
        this.binLoaderEndpoint = binLoaderEndpoint
        this.binLoaderStatusEndpoint = binLoaderStatusEndpoint
    }

    postBINLoaderPayload = (payload: ArrayBuffer): Promise<IPayloadPostResponse> => {
        return new Promise<IPayloadPostResponse>((resolve) => {
            axios.post(this.binLoaderStatusEndpoint).then(res => {
                switch (res.status) {
                    case HttpStatusCode.Status200OK:
                        axios.post<ArrayBuffer>(this.binLoaderEndpoint, payload).then(payloadResponse => {
                            if (payloadResponse.status === HttpStatusCode.Status200OK) {
                                resolve({
                                    statusCode: HttpStatusCode.Status200OK,
                                    message: "Payload sent successfully"
                                })
                            }

                            resolve({
                                statusCode: HttpStatusCode.Status500InternalServerError,
                                message: "Failed to POST payload"
                            })
                        })
                        return
                    case HttpStatusCode.Status404NotFound:
                        resolve({
                            statusCode: HttpStatusCode.Status404NotFound,
                            message: "BinLoader not enabled"
                        })
                        return
                    default:
                        resolve({
                            statusCode: HttpStatusCode.Status500InternalServerError,
                            message: `Error trying to fetch status of BinLoader ${res.status}`
                        })
                        return
                }
            })
        })
    }
}

export default AbstractPayloadService