import NinePointZeroZeroManifest from '../../manifests/manifest_900.json';
import RootManifest from '../../manifests/manifest_root.json';
import { FirmwareVersion } from '../enums';
import { toMap } from '../helpers';
import { IDirectory } from '../interfaces';
import { IManifest } from '../interfaces/manifest/interfaces';

interface IManifestService {
    getCacheFromLocalStorage: () => Map<FirmwareVersion, Map<number, IDirectory>> | null
    cacheAllManifests: () => Map<FirmwareVersion, Map<number, IDirectory>>
    clearAllCachedManifests: () => void
}

const storageKey: string = "manifests"

class ManifestService implements IManifestService {

    getCacheFromLocalStorage = (): Map<FirmwareVersion, Map<number, IDirectory>> | null => {
        const storedManifests = localStorage.getItem(storageKey)
        if (storedManifests) {
            return JSON.parse(storedManifests)
        }

        return null
    }

    clearAllCachedManifests = () => localStorage.removeItem(storageKey)

    cacheAllManifests = (): Map<FirmwareVersion, Map<number, IDirectory>> => {
        const manifests: IManifest[] = [
            {
                firmwareVersion: FirmwareVersion.Undefined,
                directoryMap: this.manifestToMap(RootManifest)
            },
            {
                firmwareVersion: FirmwareVersion.NinePointZeroZero,
                directoryMap: this.manifestToMap(NinePointZeroZeroManifest)
            }
        ]

        const map = toMap(
            manifests,
            manifest => manifest.firmwareVersion,
            manifest => manifest.directoryMap)

        localStorage.setItem(storageKey, JSON.stringify(map))

        return map
    }

    getDirectoryMapByFirmwareVersion = (firmwareVersion: FirmwareVersion): Map<number, IDirectory> | null => {
        let dirs: IDirectory[] | null = null

        switch (firmwareVersion) {
            case FirmwareVersion.NinePointZeroZero:
                dirs = NinePointZeroZeroManifest
                break
            case FirmwareVersion.Undefined:
            default:
                dirs = RootManifest
        }

        return dirs
            ? this.manifestToMap(dirs)
            : null
    }

    private manifestToMap = (dirs: IDirectory[]): Map<number, IDirectory> => toMap(dirs, dir => dir.id, dir => dir)
}

export default ManifestService