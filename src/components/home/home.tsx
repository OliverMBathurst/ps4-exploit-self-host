import React, { useContext, useEffect, useState } from 'react'
import { Item } from '../../global/components'
import { DirectoryContext } from '../../global/context'
import { ItemType } from '../../global/enums'
import { debounce } from '../../global/helpers'
import { IDirectory, IPayload } from '../../global/interfaces'
import { PayloadService } from '../../global/services'
import { HomeHeader, ItemsContainer } from './components'

const payloadService = new PayloadService()

const Home = () => {
    const { directoryMap } = useContext(DirectoryContext)
    const [currentDirectory, setCurrentDirectory] = useState<IDirectory | null>(null)

    useEffect(() => {
        if (directoryMap && !currentDirectory) {
            const rootDir = directoryMap.get(0)
            if (rootDir) {
                setCurrentDirectory(rootDir)
            }
        }

    }, [directoryMap, currentDirectory])

    const onPayloadSelected = async (payload: IPayload) => debounce(async () => await payloadService.sendPayload(payload))

    const onDirectorySwitch = (directoryId: number | null) => {
        if (directoryId === null || !directoryMap) {
            return
        }

        const dir = directoryMap.get(directoryId)
        if (dir) {
            setCurrentDirectory(dir)
        }
    }

    if (!currentDirectory) {
        return null
    }

    return (
        <div className="home">
            <HomeHeader />
            <ItemsContainer currentDirectory={currentDirectory}>
                {currentDirectory.parent !== null &&
                    <Item
                        key={`up-one-level-${currentDirectory.parent}`}
                        text="..."
                        title="Visit parent directory"
                        itemType={ItemType.Parent}
                        onClick={() => onDirectorySwitch(currentDirectory.parent)}
                    />
                }
                {currentDirectory.directories.map(directory => {
                    return (
                        <Item
                            key={directory.path}
                            text={directory.name}
                            title={`Enters the directory "${directory.path}"`}
                            itemType={ItemType.Directory}
                            onClick={() => onDirectorySwitch(directory.id)}
                        />)
                })}
                {currentDirectory.payloads.map(payload => {
                    return (
                        <Item
                            key={payload.path}
                            text={payload.name}
                            title={`Sends the ${payload.path} payload`}
                            itemType={ItemType.Payload}
                            loader={payload.loader}
                            onClick={() => onPayloadSelected(payload)}
                        />)
                })}
            </ItemsContainer>
        </div>)
}

export default Home